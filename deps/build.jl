using Libdl

QHULL_FOUND     = true
QHULL_ROOT      = haskey(ENV,"QHULL_ROOT")     ? ENV["QHULL_ROOT"]     : nothing
QHULL_LIB_DIR   = haskey(ENV,"QHULL_LIB_DIR")  ? ENV["QHULL_LIB_DIR"]  : nothing
QHULL_LIB_NAME  = haskey(ENV,"QHULL_LIB_NAME") ? ENV["QHULL_LIB_NAME"] : nothing

QHULL_LIB_PATH  = ""
QHULL_LIB_NAMES = ["libqhull.$(Libdl.dlext)",
                   "libqhull.$(Libdl.dlext)",
                   "libqhull.$(Libdl.dlext).7"]

# Check QHULL_DIR exists
if !QHULL_ROOT==nothing && isdir(QHULL_ROOT)
    @info "QHULL root directory at: $QHULL_ROOT"

    # Define default paths
    if QHULL_LIB_DIR==nothing
        QHULL_LIB_DIR = joinpath(QHULL_ROOT,"lib")
    end
else
    QHULL_ROOT = ""
end

# Check QHULL_LIB_DIR (.../lib directory) exists
if !QHULL_LIB_DIR==nothing && isdir(QHULL_LIB_DIR)
    @info "QHULL lib directory found at: $QHULL_LIB_DIR"
else
    QHULL_LIB_DIR = ""
    @warn "QHULL lib directory not found: $QHULL_LIB_DIR"
end

# Find QHull reentrant shared library  (libqhull_r.so or libqhull_r.so.7 or libqhull7_r.so file)
if QHULL_LIB_NAME==nothing
    QHULL_LIB_NAME=Libdl.find_library(QHULL_LIB_NAMES, [QHULL_LIB_DIR])
end

if isempty(QHULL_LIB_NAME)
    QHULL_FOUND = false
    @warn "QHULL library not found: $QHULL_LIB_NAMES"
else
    QHULL_LIB_PATH=Libdl.dlpath(QHULL_LIB_NAME)
    @info "QHULL library found: $QHULL_LIB_NAME"
end

# Write QHULL configuration to deps.jl file
deps_jl = "deps.jl"

if isfile(deps_jl)
  rm(deps_jl)
end

open(deps_jl,"w") do f
  println(f, "# This file is automatically generated")
  println(f, "# Do not edit")
  println(f)
  println(f, :(const QHULL_FOUND           = $QHULL_FOUND))
  println(f, :(const QHULL_LIB_DIR         = $QHULL_LIB_DIR))
  println(f, :(const QHULL_LIB_NAME        = $QHULL_LIB_NAME))
  println(f, :(const QHULL_LIB_PATH        = $QHULL_LIB_PATH))
end

@info """
QHULL configuration:
==============================================
  - QHULL_FOUND           = $QHULL_FOUND
  - QHULL_LIB_DIR         = $QHULL_LIB_DIR
  - QHULL_LIB_NAME        = $QHULL_LIB_NAME
  - QHULL_LIB_PATH        = $QHULL_LIB_PATH
"""

